name: Protect Issue Close: Author Only

on:
  issues:
    types:
      - closed

jobs:
  validate-closer:
    runs-on: ubuntu-latest

    steps:
      - name: Check if closer is issue author
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const closer = context.actor;
            const author = issue.user.login;

            if (closer !== author) {
              core.setOutput("allowed", "false");
            } else {
              core.setOutput("allowed", "true");
            }

      - name: Reopen if unauthorized
        if: steps.check.outputs.allowed == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const closer = context.actor;

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: "open"
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `❗ @${closer} 不具備關閉此 Issue 的權限（僅限作者 @${issue.user.login}）。\nIssue 已重新開啟。`
            });
